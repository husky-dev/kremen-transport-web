/* eslint-disable max-len */
import { TransportBus, TransportRoute, TransportType } from 'core/api';
import { offlineColors } from 'core';
import React, { FC, useMemo } from 'react';
import { Marker } from 'react-google-maps';
import { ColorsSet } from 'styles';

import BusPopup from './components/BusPopup';

interface Props {
  bus: TransportBus;
  route?: TransportRoute;
  size?: number;
  colors: ColorsSet;
  opacity?: number;
  zIndex?: number;
  popupOpen?: boolean;
  onClick?: (bus: TransportBus) => void;
  onPopupClose: (bus: TransportBus) => void;
}

const getIconCodeForBus = (bus: TransportBus, colors: ColorsSet, size: number) => {
  const { direction } = bus;
  const rotate = direction + 180;
  const iconCode = btoa(`<?xml version="1.0" encoding="UTF-8"?>
  <svg width="${size}px" height="${size}px" viewBox="0 0 38 38" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
      <g stroke="none" stroke-width="1.3" fill="none" fill-rule="evenodd">
      <path transform="rotate(${rotate} 19 19)" d="M19,37.179939 L24.2581419,30.3443545 L24.3664119,30.2928085 C28.6881118,28.235298 31.5,23.8715911 31.5,19 C31.5,12.0964406 25.9035594,6.5 19,6.5 C12.0964406,6.5 6.5,12.0964406 6.5,19 C6.5,23.8715911 9.31188822,28.235298 13.6335881,30.2928085 L13.7418581,30.3443545 L19,37.179939 Z" stroke="${
    colors.dark
  }" fill="${colors.light}"></path>
      ${
        bus.type === TransportType.Trolleybus
          ? '<path d="M23.7338688,25.1858997 C23.7338688,25.3765302 23.5774075,25.5323397 23.3878943,25.5323397 L20.8914963,25.5323397 C20.7020762,25.5323397 20.6109739,25.3897044 20.6907175,25.2182533 L21.0048505,24.5276078 C21.0839889,24.3548998 21.3027833,24.2133817 21.4928552,24.2133817 L23.388546,24.2133817 C23.5780127,24.2133817 23.7338688,24.368074 23.7338688,24.5587511 L23.7338688,25.1858997 Z M19.4334874,23.0311469 L19.4334874,17.6249692 L19.5210052,17.6249692 L23.0120334,17.6249692 C23.402372,17.6249692 23.7194842,17.9289072 23.7194842,18.304163 L23.7194842,22.3537221 C23.7194842,22.7290244 23.402372,23.0311469 23.0120334,23.0311469 L19.5210052,23.0311469 L19.4334874,23.0311469 Z M18.4058519,23.0311469 L14.7787988,23.0311469 C14.3897171,23.0311469 14.0725117,22.7290244 14.0725117,22.3537221 L14.0725117,18.304163 C14.0725117,17.9289072 14.3896705,17.6249692 14.7787988,17.6249692 L18.4058519,17.6249692 L18.4058519,23.0311469 L18.4058519,23.0311469 Z M16.9082738,25.5323397 L14.4118758,25.5323397 C14.2224092,25.5323397 14.0665065,25.3764836 14.0665065,25.1858997 L14.0665065,24.5587511 C14.0665065,24.368074 14.221804,24.2133817 14.4112707,24.2133817 L16.3063563,24.2133817 C16.4970334,24.2133817 16.7158278,24.3548998 16.7949662,24.5276078 L17.1097043,25.2182533 C17.1888427,25.3897044 17.0970887,25.5323397 16.9082738,25.5323397 L16.9082738,25.5323397 Z M14.0580806,16.1435446 C14.0580806,15.9535193 14.2134246,15.7982219 14.4034499,15.7982219 L17.1391252,15.7982219 L17.830376,15.7982219 L19.8633487,15.7982219 L20.5540408,15.7982219 L23.3723925,15.7982219 C23.5630695,15.7982219 23.7171101,15.9535193 23.7171101,16.1435446 L23.7171101,16.5248056 C23.7171101,16.7148774 23.5630229,16.8695232 23.3723925,16.8695232 L20.5539943,16.8695232 L19.8633021,16.8695232 L17.8303294,16.8695232 L17.1390787,16.8695232 L14.4034034,16.8695232 C14.2133781,16.8695232 14.0580806,16.7148774 14.0580806,16.5248056 L14.0580806,16.1435446 L14.0580806,16.1435446 Z M23.7069152,14.8635041 L21.6937271,14.8635041 L20.6589225,14.8635041 L24.7878528,10.7304306 C24.9035811,10.6153075 24.8028426,10.4510255 24.6871608,10.3359024 C24.5720377,10.2202206 24.38434,10.1968515 24.2692169,10.3125333 L19.7014408,14.8635041 L17.4106631,14.8635041 L22.2836341,9.99360547 C22.3992693,9.87848236 22.2991825,9.71485205 22.182849,9.59912376 C22.0677259,9.48344202 21.8806799,9.46058498 21.7662086,9.5757081 L16.4562538,14.8635041 L16.0970585,14.8635041 L14.0827066,14.8635041 C13.4849788,14.8635041 13,15.3335863 13,15.913857 L13,25.2254224 C13,25.8033655 13.4849788,26.274565 14.0827066,26.274565 L14.4730452,26.274565 L14.4730452,27.2410312 C14.4730452,27.3837131 14.5893321,27.5 14.7326192,27.5 L15.5911313,27.5 C15.7338132,27.5 15.8507053,27.3837131 15.8507053,27.2410312 L15.8507053,26.274565 L21.964008,26.274565 L21.964008,27.2410312 C21.964008,27.3837131 22.0815053,27.5 22.2248855,27.5 L23.0827459,27.5 C23.226033,27.5 23.3423664,27.3837131 23.3423664,27.2410312 L23.3423664,26.274565 L23.7069152,26.274565 C24.3070171,26.274565 24.792089,25.8033655 24.792089,25.2254224 L24.792089,15.913857 C24.7920425,15.3335863 24.3069706,14.8635041 23.7069152,14.8635041 L23.7069152,14.8635041 Z" id="icon-trolleybus" fill="#FFFFFF" fill-rule="nonzero"></path>'
          : '<path d="M18.1031971,26.9835324 C17.0771041,26.9016935 16.5447481,26.8296687 15.7462955,26.6626641 C14.7586586,26.4532431 13.8767759,26.1684704 13.2386657,25.8411149 C12.6999547,25.569483 12.4273402,25.3500816 12.3119719,25.0915905 C12.2542878,24.9671688 12.2510288,24.744607 12.2510288,19.6742559 C12.2510288,16.1390492 12.2639018,14.3158053 12.2863888,14.1750824 C12.360205,13.6938631 12.7064727,13.2126439 13.1265565,12.9967356 L13.3253548,12.8952687 L13.3413239,12.1653723 C13.3572929,11.4386364 13.3572929,11.435476 13.4470781,11.3012403 C13.4951482,11.2258886 13.5945474,11.1310753 13.6714596,11.0918192 C13.7966048,11.0231211 13.8542889,11.0164676 14.418583,11.0066536 C15.1528335,10.9935128 15.2587506,11.0131408 15.444676,11.2129142 C15.6209874,11.3995467 15.6498294,11.5435965 15.6498294,12.2440508 L15.6498294,12.8004554 L22.3196783,12.8004554 L22.3196783,12.1555583 C22.3196783,11.425662 22.3485203,11.3110543 22.5473187,11.1538637 C22.717275,11.0261153 22.8680033,11 23.4772715,11 C24.0736667,11 24.1859389,11.019628 24.3655092,11.1538637 C24.5771806,11.3142147 24.5964086,11.4058676 24.5964086,12.1850004 L24.5964086,12.8822942 L24.8144351,12.9969019 C25.0837906,13.1376249 25.3852472,13.4420256 25.5038744,13.690869 C25.6994138,14.1032239 25.6867037,13.7530799 25.6801857,19.6614478 L25.6705717,25.0624811 L25.5807866,25.1998773 C25.4429313,25.4126251 25.1639617,25.6155589 24.6765798,25.8610756 C23.5445696,26.4272942 21.7425111,26.8496294 19.9306757,26.9740511 C19.4884307,27.0031604 18.4110087,27.009814 18.1031971,26.9835324 Z M21.1935705,25.7131567 C21.3832159,25.5495119 21.3864828,25.2942326 21.1968375,25.1241019 C21.1261084,25.0585774 21.0811881,25.0585774 19.0205715,25.0585774 L16.9150347,25.0585774 L16.8217638,25.1665098 C16.6577639,25.3531048 16.7188555,25.6737422 16.9343096,25.7622169 C16.9695924,25.7785148 17.9243529,25.791653 19.0494839,25.791653 L21.0939292,25.7949791 L21.1935705,25.7131567 Z M18.668935,23.8748524 C18.8416708,23.7765555 18.8416708,23.7895506 18.8320834,21.7994552 L18.822496,19.9601373 L18.7170345,19.8650059 L18.6146605,19.7698745 L16.1713334,19.7698745 C13.7570936,19.7698745 13.7281689,19.7698745 13.6482196,19.8386823 C13.6002826,19.8748356 13.5490955,19.9599707 13.5299207,20.025613 C13.5044085,20.1075826 13.4979085,20.7173565 13.5044085,21.9174115 C13.5139959,23.8878475 13.5076584,23.835367 13.7314188,23.8943451 C13.7858558,23.9106724 14.9049828,23.9205021 16.2160205,23.9205021 C18.0676906,23.9175032 18.614498,23.9076735 18.668935,23.8748524 Z M24.3314875,23.8774945 C24.5042222,23.7791343 24.5042222,23.7921379 24.4946349,21.8007616 L24.4850475,19.9602597 L24.3795867,19.8650671 L24.2772134,19.7698745 L19.3845798,19.7698745 L19.2822064,19.8650671 L19.1767456,19.9602597 L19.1671583,21.744913 C19.1608209,22.7258471 19.1671583,23.5722446 19.1767456,23.6312607 C19.2055077,23.8018072 19.2917938,23.8804953 19.4677784,23.9035016 C19.5540645,23.9133376 20.6668466,23.9231736 21.942776,23.9198394 C23.7334972,23.9201728 24.2770509,23.9103368 24.3314875,23.8774945 Z M14.9841352,17.8562576 C15.1964172,17.7501878 15.3673371,17.5580835 15.4719492,17.3161434 C15.5416369,17.1538397 15.5511324,17.1008048 15.538418,16.8457322 C15.5289225,16.6005931 15.5099314,16.5308901 15.4275293,16.3751527 C15.0126219,15.5998329 13.9452573,15.6463016 13.5937609,16.4546208 C13.3404389,17.0410353 13.6317431,17.7202188 14.2240081,17.9224249 C14.4330713,17.9953269 14.7750721,17.9655263 14.9841352,17.8562576 Z M23.8831909,17.8832021 C24.3038075,17.6896969 24.5694855,17.1932355 24.4809262,16.7514996 C24.4113324,16.3936542 24.1962827,16.1065914 23.8831909,15.9615854 C23.6681413,15.8616377 23.253793,15.8616377 23.0514406,15.9648623 C22.6814523,16.1487005 22.4821536,16.4452665 22.4599736,16.8419441 C22.4442226,17.13212 22.4852074,17.2997372 22.6213412,17.5061864 C22.8330157,17.8284767 23.1335709,17.9800367 23.5130419,17.9607025 C23.6459613,17.9541486 23.7946316,17.9220343 23.8831909,17.8832021 Z M11.5875451,23.8679128 C11.4000071,23.7953932 11.190714,23.5845336 11.0874966,23.3669748 L11,23.1790603 L11,21.7784102 C11,20.4238175 11.0031759,20.3744104 11.0655827,20.2260216 C11.1030586,20.1436205 11.1780103,20.0250434 11.231207,19.955706 C11.3530035,19.8106668 11.6748829,19.6359833 11.8187521,19.6359833 L11.9218107,19.6359833 L11.9218107,23.9205021 L11.8217692,23.9171525 C11.7655554,23.9173199 11.6593209,23.8943749 11.5875451,23.8679128 Z M26.0781893,23.9205021 L26.0781893,19.6359833 L26.1656859,19.6359833 C26.4313516,19.6359833 26.7656171,19.8761008 26.9156793,20.1752034 L27,20.3429681 L27,23.2036585 L26.9156793,23.3714233 C26.768793,23.6640091 26.5094792,23.8646919 26.2312686,23.9007847 L26.0781893,23.9205021 Z" id="Shape" fill="#FFFFFF" fill-rule="nonzero" transform="translate(19.000000, 19.000000) rotate(180.000000) translate(-19.000000, -19.000000) "></path>'
      }
      </g>
  </svg>
  `);
  return `data:image/svg+xml;base64,${iconCode}`;
};

export const BusMarker: FC<Props> = ({
  onClick,
  bus,
  route,
  popupOpen,
  colors,
  size = 38,
  opacity = 1.0,
  zIndex = 20,
  onPopupClose,
}) => {
  const onMarkerClick = () => {
    if (onClick) {
      onClick(bus);
    }
  };

  const handlePopupClose = () => {
    onPopupClose(bus);
  };

  const { lat, lng } = bus;
  return useMemo(
    () => (
      <Marker
        position={{ lat, lng }}
        title={bus.name}
        icon={{
          url: getIconCodeForBus(bus, bus.offline ? offlineColors : colors, size),
          anchor: new google.maps.Point(Math.round(size / 2), Math.round(size / 2)),
        }}
        zIndex={zIndex}
        opacity={opacity}
        onClick={onMarkerClick}
      >
        {popupOpen && <BusPopup bus={bus} route={route} onClose={handlePopupClose} />}
      </Marker>
    ),
    [lat, lng, opacity, zIndex, size, popupOpen, bus.offline, bus.direction],
  );
};

export default BusMarker;
