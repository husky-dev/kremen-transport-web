/* eslint-disable max-len */
import { TransportBus, TransportRoute, TransportType } from '@core/api';
import { clearRouteNumber, offlineColors } from '@core';
import React, { FC, useMemo } from 'react';
import { Marker } from 'react-google-maps';
import { ColorsSet } from '@styles';

import BusPopup from './components/BusPopup';

interface Props {
  bus: TransportBus;
  route?: TransportRoute;
  width?: number;
  height?: number;
  colors: ColorsSet;
  opacity?: number;
  zIndex?: number;
  popupOpen?: boolean;
  onClick?: (bus: TransportBus) => void;
  onPopupClose: (bus: TransportBus) => void;
}

const getIconCode = (bus: TransportBus, route: TransportRoute | undefined, colors: ColorsSet) => {
  const { direction } = bus;
  const rotate = direction + 180;
  const iconCode = btoa(`<?xml version="1.0" encoding="UTF-8"?>
  <svg width="85px" height="46px" viewBox="0 0 85 46" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
  <g id="Services" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
      ${getLabelCode(route?.number, direction < 180 ? 'left' : 'right')}
      <g id="pin" transform="translate(26.800736, 7.263158) rotate(${rotate} 15.735 15.735)" fill="${
    colors.light
  }" stroke="${colors.dark}">
        <path d="M15.7368421,0.5 C19.9443799,0.5 23.7535904,2.20544164 26.5109165,4.96276773 C29.2682426,7.72009381 30.9736842,11.5293043 30.9736842,15.7368421 C30.9736842,18.7238922 30.1142852,21.510251 28.628958,23.8619248 C27.073393,26.3248039 24.8316757,28.3111007 22.1722504,29.5521002 L22.1722504,29.5521002 L15.7368236,37.9168835 L9.30043773,29.5516353 C6.64128615,28.3105287 4.39982277,26.3242534 2.84444085,23.861473 C1.35928889,21.5098942 0.5,18.7237009 0.5,15.7368421 C0.5,11.5293043 2.20544164,7.72009381 4.96276773,4.96276773 C7.72009381,2.20544164 11.5293043,0.5 15.7368421,0.5 Z"></path>
      </g>
      <g id="icon" transform="translate(32.853368, 10.894737)" fill="#FFFFFF" fill-rule="nonzero">
        ${
          bus.type === TransportType.Trolleybus
            ? '<path d="M15.6139469,18.9881944 C15.6139469,19.2189576 15.4245464,19.4075691 15.1951356,19.4075691 L12.1731802,19.4075691 C11.9438821,19.4075691 11.8336004,19.2349053 11.9301321,19.0273593 L12.3103984,18.1913147 C12.4061975,17.9822471 12.6710539,17.8109357 12.9011409,17.8109357 L15.1959245,17.8109357 C15.425279,17.8109357 15.6139469,17.9981948 15.6139469,18.2290145 L15.6139469,18.9881944 Z M10.408222,16.3798094 L10.408222,9.83548903 L10.5141646,9.83548903 L14.7401461,9.83548903 C15.2126613,9.83548903 15.5965339,10.203414 15.5965339,10.657671 L15.5965339,15.5597689 C15.5965339,16.0140822 15.2126613,16.3798094 14.7401461,16.3798094 L10.5141646,16.3798094 L10.408222,16.3798094 Z M4.77359898,16.3798094 C4.30260534,16.3798094 3.91861986,16.0140822 3.91861986,15.5597689 L3.91861986,10.657671 C3.91861986,10.203414 4.30254893,9.83548903 4.77359898,9.83548903 L9.16424221,9.83548903 L9.16424221,16.3798094 L4.77359898,16.3798094 Z M4.32942903,19.4075691 C4.10007473,19.4075691 3.91135041,19.2189012 3.91135041,18.9881944 L3.91135041,18.2290145 C3.91135041,17.9981948 4.09934212,17.8109357 4.32869654,17.8109357 L6.62274753,17.8109357 C6.85356718,17.8109357 7.11842356,17.9822471 7.21422268,18.1913147 L7.59522143,19.0273593 C7.69102054,19.2349053 7.57994991,19.4075691 7.35138451,19.4075691 L4.32942903,19.4075691 Z M4.31922926,7.62416336 L7.6308362,7.62416336 L8.46761349,7.62416336 L10.9285804,7.62416336 L11.7646814,7.62416336 L15.1763703,7.62416336 C15.4071898,7.62416336 15.59366,7.81215494 15.59366,8.04218557 L15.59366,8.50371204 C15.59366,8.73379896 15.4071334,8.92100177 15.1763703,8.92100177 L11.7646251,8.92100177 L10.928524,8.92100177 L8.46755708,8.92100177 L7.63077991,8.92100177 L4.31917297,8.92100177 C4.08914234,8.92100177 3.90115063,8.73379896 3.90115063,8.50371204 L3.90115063,8.04218557 C3.90115063,7.81215494 4.08919863,7.62416336 4.31922926,7.62416336 Z M13.1443017,6.49266286 L11.8916435,6.49266286 L16.8898222,1.48946862 C17.0299144,1.35010908 16.9079678,1.1512414 16.7679319,1.01188186 C16.6285724,0.871845992 16.4013594,0.843557081 16.2619998,0.983592945 L10.7325867,6.49266286 L7.95953998,6.49266286 L13.8583996,0.597522414 C13.9983791,0.458162859 13.8772214,0.260084063 13.7363966,0.119991923 C13.597037,-0.020043868 13.3706129,-0.0477129164 13.2320424,0.0916466499 L6.8042024,6.49266286 L6.36938704,6.49266286 L3.93096105,6.49266286 C3.20739582,6.49266286 2.62031622,7.06170973 2.62031622,7.76414269 L2.62031622,19.0360376 C2.62031622,19.735653 3.20739582,20.3060524 3.93096105,20.3060524 L4.4034762,20.3060524 L4.4034762,21.4759851 C4.4034762,21.6487053 4.54424455,21.7894737 4.71769736,21.7894737 L5.75694885,21.7894737 C5.92966904,21.7894737 6.07117001,21.6487053 6.07117001,21.4759851 L6.07117001,20.3060524 L13.4714838,20.3060524 L13.4714838,21.4759851 C13.4714838,21.6487053 13.6137174,21.7894737 13.7872829,21.7894737 L14.8257455,21.7894737 C14.9991983,21.7894737 15.1400229,21.6487053 15.1400229,21.4759851 L15.1400229,20.3060524 L15.5813188,20.3060524 C16.307758,20.3060524 16.8949503,19.735653 16.8949503,19.0360376 L16.8949503,7.76414269 C16.894894,7.06170973 16.3077017,6.49266286 15.5813188,6.49266286 L13.1443017,6.49266286 Z" id="trolleybus"></path>'
            : '<path d="M8.59860697,21.7695392 C7.35649441,21.6704711 6.71206345,21.5832831 5.74551564,21.3811197 C4.54995518,21.12761 3.48241298,20.7828852 2.70996376,20.3866127 C2.05783987,20.0577952 1.72783283,19.792204 1.58817653,19.4792938 C1.51834839,19.328678 1.51440329,19.0592611 1.51440329,12.9214676 C1.51440329,8.64200688 1.52998641,6.43492225 1.55720755,6.26457342 C1.64656391,5.68204483 2.06573005,5.09951625 2.57425255,4.83815361 L2.81490323,4.71532525 L2.83423419,3.83176652 C2.85356514,2.95203358 2.85356514,2.94820778 2.96225246,2.7857119 C3.02044258,2.69449674 3.14076792,2.57972271 3.23387212,2.53220223 C3.38536369,2.44904139 3.45519184,2.44098707 4.13828471,2.42910695 C5.02711419,2.41319967 5.15532971,2.43695991 5.38039727,2.67879082 C5.59382681,2.90471446 5.62874088,3.07909045 5.62874088,3.92700883 L5.62874088,4.60055122 L13.7027684,4.60055122 L13.7027684,3.8198864 C13.7027684,2.93632766 13.7376825,2.79759202 13.9783332,2.60730875 C14.1840698,2.45266583 14.3665303,2.42105263 15.1040655,2.42105263 C15.8260175,2.42105263 15.961926,2.44481287 16.1793006,2.60730875 C16.4355344,2.80141782 16.4588105,2.91236606 16.4588105,3.85552675 L16.4588105,4.69961933 L16.7227372,4.83835497 C17.0487991,5.0087038 17.4137202,5.37718888 17.5573216,5.67842039 C17.7940272,6.17758678 17.7786414,5.75372827 17.7707512,12.9059631 L17.7591131,19.4440561 L17.6504258,19.6103778 C17.4835484,19.8679146 17.1458484,20.1135713 16.5558597,20.4107757 C15.1855317,21.0961982 13.0040924,21.6074461 10.8108179,21.7580618 C10.2754688,21.7932995 8.97122101,21.8013538 8.59860697,21.7695392 Z M12.3395854,20.231716 C12.5691561,20.0336196 12.5731108,19.7245974 12.3435401,19.5186496 C12.2579207,19.4393305 12.2035435,19.4393305 9.70911293,19.4393305 L7.16030513,19.4393305 L7.04739828,19.5699856 C6.84887206,19.7958637 6.92282505,20.1840037 7.18363789,20.2911046 C7.22634871,20.3108337 8.38211144,20.3267378 9.74411207,20.3267378 L12.2189669,20.3307641 L12.3395854,20.231716 Z M9.28344757,18.0064002 C9.4925489,17.8874093 9.4925489,17.9031403 9.48094309,15.4940774 L9.46933728,13.2675346 L9.34167334,13.1523755 L9.21774688,13.0372165 L6.26003518,13.0372165 C3.33753434,13.0372165 3.3025202,13.0372165 3.20573953,13.1205101 C3.14771047,13.1642746 3.08574723,13.2673329 3.06253561,13.3467947 C3.03165235,13.446021 3.023784,14.1841684 3.03165235,15.6368666 C3.04325816,18.0221312 3.03558652,17.9586021 3.30645437,18.0299967 C3.37235178,18.0497613 4.72708445,18.0616604 6.31413007,18.0616604 C8.55562546,18.0580302 9.21755017,18.0461311 9.28344757,18.0064002 Z M16.1381165,18.0095986 C16.3472164,17.8905311 16.3472164,17.9062722 16.3356106,15.4956587 L16.3240049,13.2676828 L16.1963418,13.1524496 L16.0724162,13.0372165 L10.1497545,13.0372165 L10.0258288,13.1524496 L9.89816576,13.2676828 L9.88656003,15.4280526 C9.87888844,16.6154992 9.88656003,17.6400856 9.89816576,17.7115261 C9.93298296,17.9179771 10.0374346,18.0132312 10.2504686,18.0410809 C10.3549202,18.0529876 11.7019722,18.0648944 13.2465184,18.0608582 C15.4142334,18.0612618 16.0722195,18.0493551 16.1381165,18.0095986 Z M4.82290054,10.7207328 C5.07987342,10.5923325 5.28677653,10.3597853 5.41341214,10.0669104 C5.49777094,9.87043757 5.50926556,9.80623743 5.49387446,9.4974653 C5.48237984,9.20071796 5.45939061,9.11634062 5.35964071,8.92781639 C4.85738439,7.9892714 3.56531151,8.04552296 3.13981585,9.0240147 C2.83316285,9.73388488 3.18579432,10.5560544 3.9027467,10.8008302 C4.1558231,10.8890799 4.56982414,10.8530055 4.82290054,10.7207328 Z M15.5954417,10.75335 C16.1046091,10.5191068 16.4262193,9.91812724 16.3190159,9.38339429 C16.2347707,8.950213 15.9744475,8.60271592 15.5954417,8.42718229 C15.3351184,8.30619301 14.8335389,8.30619301 14.5885859,8.43114915 C14.1407054,8.65369009 13.8994491,9.01269107 13.8725996,9.49287967 C13.8535326,9.84414527 13.9031458,10.0470502 14.0679394,10.2969625 C14.3241769,10.6871034 14.6880069,10.8705707 15.1473666,10.8471662 C15.3082689,10.8392325 15.4882383,10.8003573 15.5954417,10.75335 Z M0.711238864,17.9979997 C0.484219108,17.9102128 0.230864291,17.6549618 0.105916923,17.3916011 L6.88338275e-14,17.1641256 L6.88338275e-14,15.4686018 C6.88338275e-14,13.8288318 0.0038445344,13.7690231 0.0793896354,13.5893945 C0.124755141,13.4896459 0.215486153,13.3461052 0.279882104,13.2621704 C0.427319999,13.0865966 0.81696356,12.8751376 0.991120969,12.8751376 L1.11587611,12.8751376 L1.11587611,18.0616604 L0.994773276,18.0576056 C0.926725017,18.0578083 0.798125342,18.0300328 0.711238864,17.9979997 Z M18.2525449,18.0616604 L18.2525449,12.8751376 L18.3584619,12.8751376 C18.6800572,12.8751376 19.0846944,13.1658062 19.2663487,13.5278777 L19.3684211,13.7309614 L19.3684211,17.1939024 L19.2663487,17.3969861 C19.0885389,17.7511689 18.7746327,17.9941007 18.4378515,18.037792 L18.2525449,18.0616604 Z" id="bus" transform="translate(9.684211, 12.105263) rotate(180.000000) translate(-9.684211, -12.105263) "></path>'
        }
      </g>
    </g>
  </svg>
  `);
  return `data:image/svg+xml;base64,${iconCode}`;
};

const getLabelCode = (label: string = '', position: 'left' | 'right' = 'left') => {
  const mod = clearRouteNumber(label);
  let x = position === 'left' ? 7 : 22;
  let y = 14;
  let fontSize = 12;
  if (mod.length === 1) x += 5;
  if (mod.length === 2) x += 1;
  if (mod.length >= 3) {
    x -= 4;
    y = 13;
    fontSize = 9;
  }

  return `
  <g id="label" transform="translate(${position === 'left' ? 0 : 42}, 12.000000)">
    <rect id="background" fill="#FFFFFF" opacity="0.800013951" x="0" y="0" width="43" height="19.3684211" rx="5"></rect>
    <text id="text" font-family="Roboto-Bold, Roboto" font-size="${fontSize}" font-weight="bold" fill="#000000">
      <tspan x="${x}" y="${y}">${unescape(encodeURIComponent(mod))}</tspan>
    </text>
  </g>
  `;
};

export const BusMarker: FC<Props> = ({
  onClick,
  bus,
  route,
  popupOpen,
  colors,
  opacity = 1.0,
  zIndex = 20,
  onPopupClose,
}) => {
  const onMarkerClick = () => {
    if (onClick) {
      onClick(bus);
    }
  };

  const handlePopupClose = () => {
    onPopupClose(bus);
  };

  const { lat, lng } = bus;
  return useMemo(
    () => (
      <Marker
        position={{ lat, lng }}
        title={bus.name}
        icon={{
          url: getIconCode(bus, route, bus.offline ? offlineColors : colors),
          anchor: new google.maps.Point(Math.round(85 / 2), Math.round(46 / 2)),
        }}
        zIndex={zIndex}
        opacity={opacity}
        onClick={onMarkerClick}
      >
        {popupOpen && <BusPopup bus={bus} route={route} onClose={handlePopupClose} />}
      </Marker>
    ),
    [lat, lng, opacity, zIndex, popupOpen, bus.offline, bus.direction],
  );
};

export default BusMarker;
